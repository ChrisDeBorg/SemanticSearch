@page "/knowledge-graph"

@using Minerva.Persistence
@using Minerva.Persistence.Entities
@using Minerva.Persistence.Relations
@using Microsoft.EntityFrameworkCore
@inject MinervaDbContext DbContext
@inject ILogger<KnowledgeGraphPage> Logger

<PageTitle>Knowledge Graph</PageTitle>

<div class="kg-container">
    <h1>🕸️ Knowledge Graph</h1>

    <!-- ── Tabs ── -->
    <div class="tab-navigation">
        <button class="tab-btn @(activeTab == "entities" ? "active" : "")"
                @onclick="@(() => activeTab = "entities")">
            📊 Entities (@totalEntities)
        </button>
        <button class="tab-btn @(activeTab == "relations" ? "active" : "")"
                @onclick="@(() => activeTab = "relations")">
            🔗 Relationen (@totalRelations)
        </button>
        <button class="tab-btn @(activeTab == "extract" ? "active" : "")"
                @onclick="@(() => activeTab = "extract")">
            🔍 Neu extrahieren
        </button>
    </div>

    <!-- ────────────────────── ENTITIES TAB ────────────────────── -->
    @if (activeTab == "entities")
    {
        <div class="tab-content">
            <!-- Filter -->
            <div class="filter-bar">
                <input type="text"
                       class="search-input"
                       placeholder="Nach Name suchen..."
                       @bind="entitySearchQuery"
                       @bind:event="oninput"
                       @onkeyup="FilterEntities" />

                <select class="filter-select" @onchange="OnEntityTypeFilterChanged">
                    <option value="">Alle Typen</option>
                    <option value="Person">👤 Person</option>
                    <option value="Organization">🏢 Organization</option>
                    <option value="Organization:Company">🏭 Company</option>
                    <option value="Organization:Bank">🏦 Bank</option>
                    <option value="Organization:NGO">🌍 NGO</option>
                    <option value="Organization:Agency">🛡️ Agency</option>
                    <option value="Organization:SecretService">🕵️ Secret Service</option>
                    <option value="Event">📅 Event</option>
                </select>

                <button class="btn btn-sm btn-secondary" @onclick="LoadEntities">
                    🔄 Aktualisieren
                </button>
            </div>

            <!-- Entity Grid -->
            @if (isLoadingEntities)
            {
                <div class="loading">Lade Entities...</div>
            }
            else if (filteredEntities.Count == 0)
            {
                <div class="empty-state">
                    <span class="empty-icon">📭</span>
                    <p>Keine Entities gefunden.</p>
                    <p class="empty-hint">Gehen Sie zum Tab "Neu extrahieren" um Entities aus Dokumenten zu extrahieren.</p>
                </div>
            }
            else
            {
                <div class="entity-grid">
                    @foreach (var entity in filteredEntities.Take(100))
                    {
                        <div class="entity-card" @onclick="@(() => SelectEntity(entity))">
                            <div class="entity-card-header">
                                <span class="entity-icon">@GetEntityIcon(entity.EntityType)</span>
                                <span class="entity-type-badge">@GetShortType(entity.EntityType)</span>
                            </div>

                            <h3 class="entity-name">@entity.Name</h3>

                            @if (!string.IsNullOrEmpty(entity.Description))
                            {
                                <p class="entity-description">@entity.Description</p>
                            }

                            <div class="entity-meta">
                                @if (entity is Person person)
                                {
                                    @if (person.BirthDate.HasValue)
                                    {
                                        <span>🎂 @person.BirthDate.Value.ToString("yyyy")</span>
                                    }
                                }
                                @if (entity is Organization org)
                                {
                                    @if (org.FoundingDate.HasValue)
                                    {
                                        <span>📅 @org.FoundingDate.Value.ToString("yyyy")</span>
                                    }
                                }

                                <span class="relation-count">
                                    🔗 @(entity.OutgoingRelations.Count + entity.IncomingRelations.Count) Relationen
                                </span>
                            </div>
                        </div>
                    }
                </div>

                @if (filteredEntities.Count > 100)
                {
                    <div class="pagination-info">
                        Zeige 100 von @filteredEntities.Count Entities
                    </div>
                }
            }
        </div>
    }

    <!-- ────────────────────── RELATIONS TAB ────────────────────── -->
    @if (activeTab == "relations")
    {
        <div class="tab-content">
            <div class="filter-bar">
                <select class="filter-select" @onchange="OnRelationTypeFilterChanged">
                    <option value="">Alle Relationstypen</option>
                    <option value="Work:Employment">💼 Employment</option>
                    <option value="Work:Leadership">👔 Leadership</option>
                    <option value="Work:Membership">🎫 Membership</option>
                    <option value="Family:Parent">👨‍👩‍👧 Parent</option>
                    <option value="Family:Child">👶 Child</option>
                    <option value="Influence:Control">🎯 Control</option>
                </select>

                <button class="btn btn-sm btn-secondary" @onclick="LoadRelations">
                    🔄 Aktualisieren
                </button>
            </div>

            @if (isLoadingRelations)
            {
                <div class="loading">Lade Relationen...</div>
            }
            else if (filteredRelations.Count == 0)
            {
                <div class="empty-state">
                    <span class="empty-icon">🔗</span>
                    <p>Keine Relationen gefunden.</p>
                </div>
            }
            else
            {
                <div class="relations-list">
                    @foreach (var relation in filteredRelations.Take(100))
                    {
                        <div class="relation-card">
                            <div class="relation-source">
                                <span class="entity-icon">@GetEntityIcon(relation.SourceEntity.EntityType)</span>
                                <strong>@relation.SourceEntity.Name</strong>
                            </div>

                            <div class="relation-type">
                                <span class="relation-arrow">→</span>
                                <span class="relation-label">@relation.RelationType</span>
                                @if (relation is OrganizationMember om && !string.IsNullOrEmpty(om.Role))
                                {
                                    <span class="relation-role">(@om.Role)</span>
                                }
                            </div>

                            <div class="relation-target">
                                <span class="entity-icon">@GetEntityIcon(relation.TargetEntity.EntityType)</span>
                                <strong>@relation.TargetEntity.Name</strong>
                            </div>

                            @if (relation.FromDate.HasValue || relation.ToDate.HasValue)
                            {
                                <div class="relation-dates">
                                    📅
                                    @(relation.FromDate?.ToString("yyyy-MM-dd") ?? "?")
                                    bis
                                    @(relation.ToDate?.ToString("yyyy-MM-dd") ?? "heute")
                                </div>
                            }
                        </div>
                    }
                </div>

                @if (filteredRelations.Count > 100)
                {
                    <div class="pagination-info">
                        Zeige 100 von @filteredRelations.Count Relationen
                    </div>
                }
            }
        </div>
    }

    <!-- ────────────────────── EXTRACT TAB ────────────────────── -->
    @if (activeTab == "extract")
    {
        <div class="tab-content">
            <div class="extract-info">
                <h2>Entity Extraction aus Dokumenten</h2>
                <p>Wählen Sie bereits indexierte Dokumente aus, um Entities und Relationen zu extrahieren.</p>
            </div>

            <div class="extract-options">
                <label class="checkbox-label">
                    <input type="checkbox" @bind="useLLMExtraction" />
                    <span>🤖 LLM-basierte Extraktion verwenden (bessere Qualität, langsamer)</span>
                </label>
            </div>

            <button class="btn btn-primary btn-lg" @onclick="StartExtraction" disabled="@isExtracting">
                @if (isExtracting)
                {
                    <span>⏳ Extrahiere...</span>
                }
                else
                {
                    <span>🔍 Extraktion starten</span>
                }
            </button>

            @if (extractionResults.Any())
            {
                <div class="extraction-results">
                    <h3>Extraktionsergebnisse</h3>
                    @foreach (var result in extractionResults)
                    {
                        <div class="result-item">
                            <strong>@result.DocumentName</strong>:
                            @result.EntitiesCount Entities,
                            @result.RelationsCount Relationen
                        </div>
                    }
                </div>
            }
        </div>
    }
</div>

<!-- ────────────────────── ENTITY DETAIL MODAL ────────────────────── -->
@if (selectedEntity != null)
{
    <div class="modal-backdrop" @onclick="CloseEntityDetail">
        <div class="modal-content" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h2>@selectedEntity.Name</h2>
                <button class="btn-close" @onclick="CloseEntityDetail">✕</button>
            </div>

            <div class="modal-body">
                <div class="detail-section">
                    <label>Typ:</label>
                    <span>@selectedEntity.EntityType</span>
                </div>

                @if (!string.IsNullOrEmpty(selectedEntity.Description))
                {
                    <div class="detail-section">
                        <label>Beschreibung:</label>
                        <p>@selectedEntity.Description</p>
                    </div>
                }

                @if (selectedEntity is Person person)
                {
                    @if (person.BirthDate.HasValue)
                    {
                        <div class="detail-section">
                            <label>Geburtsdatum:</label>
                            <span>@person.BirthDate.Value.ToString("dd.MM.yyyy")</span>
                        </div>
                    }
                    @if (!string.IsNullOrEmpty(person.GivenName))
                    {
                        <div class="detail-section">
                            <label>Vorname:</label>
                            <span>@person.GivenName</span>
                        </div>
                    }
                    @if (!string.IsNullOrEmpty(person.FamilyName))
                    {
                        <div class="detail-section">
                            <label>Nachname:</label>
                            <span>@person.FamilyName</span>
                        </div>
                    }
                }

                @if (selectedEntity is Organization org)
                {
                    @if (org.FoundingDate.HasValue)
                    {
                        <div class="detail-section">
                            <label>Gründungsdatum:</label>
                            <span>@org.FoundingDate.Value.ToString("dd.MM.yyyy")</span>
                        </div>
                    }
                }

                <div class="detail-section">
                    <label>Ausgehende Relationen (@selectedEntity.OutgoingRelations.Count):</label>
                    <ul class="relation-list">
                        @foreach (var rel in selectedEntity.OutgoingRelations.Take(10))
                        {
                            <li>→ @rel.RelationType: @rel.TargetEntity.Name</li>
                        }
                    </ul>
                </div>

                <div class="detail-section">
                    <label>Eingehende Relationen (@selectedEntity.IncomingRelations.Count):</label>
                    <ul class="relation-list">
                        @foreach (var rel in selectedEntity.IncomingRelations.Take(10))
                        {
                            <li>← @rel.RelationType: @rel.SourceEntity.Name</li>
                        }
                    </ul>
                </div>
            </div>
        </div>
    </div>
}

<!-- ────────────────────── STYLES ────────────────────── -->
<style>
    .kg-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 24px 20px;
        font-family: system-ui, -apple-system, sans-serif;
    }

        .kg-container h1 {
            margin: 0 0 24px;
            color: #1e293b;
        }

    /* Tabs */
    .tab-navigation {
        display: flex;
        gap: 8px;
        margin-bottom: 24px;
        border-bottom: 2px solid #e2e8f0;
    }

    .tab-btn {
        padding: 12px 24px;
        background: none;
        border: none;
        border-bottom: 3px solid transparent;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 600;
        color: #64748b;
        transition: all 0.2s;
    }

        .tab-btn:hover {
            color: #1e293b;
        }

        .tab-btn.active {
            color: #0f766e;
            border-bottom-color: #0f766e;
        }

    /* Filter Bar */
    .filter-bar {
        display: flex;
        gap: 12px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .search-input {
        flex: 1;
        min-width: 200px;
        padding: 10px 14px;
        border: 2px solid #cbd5e0;
        border-radius: 8px;
        font-size: 0.95rem;
    }

    .filter-select {
        padding: 10px 14px;
        border: 2px solid #cbd5e0;
        border-radius: 8px;
        font-size: 0.95rem;
        background: white;
    }

    /* Entity Grid */
    .entity-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 16px;
    }

    .entity-card {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 18px;
        cursor: pointer;
        transition: all 0.2s;
    }

        .entity-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

    .entity-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }

    .entity-icon {
        font-size: 1.5rem;
    }

    .entity-type-badge {
        font-size: 0.75rem;
        font-weight: 700;
        padding: 4px 10px;
        background: #e0f2fe;
        color: #0369a1;
        border-radius: 12px;
    }

    .entity-name {
        margin: 0 0 8px;
        font-size: 1.1rem;
        color: #0f766e;
    }

    .entity-description {
        font-size: 0.9rem;
        color: #64748b;
        margin: 0 0 12px;
        line-height: 1.5;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .entity-meta {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        font-size: 0.85rem;
        color: #64748b;
    }

    .relation-count {
        font-weight: 600;
        color: #0f766e;
    }

    /* Relations List */
    .relations-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .relation-card {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        padding: 16px;
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        gap: 12px;
        align-items: center;
    }

    .relation-source, .relation-target {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .relation-type {
        text-align: center;
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .relation-arrow {
        font-size: 1.2rem;
        color: #0f766e;
    }

    .relation-label {
        font-size: 0.85rem;
        font-weight: 600;
        color: #0f766e;
        background: #f0fdfa;
        padding: 4px 12px;
        border-radius: 12px;
    }

    .relation-role {
        font-size: 0.8rem;
        color: #64748b;
    }

    .relation-dates {
        grid-column: 1 / -1;
        font-size: 0.85rem;
        color: #64748b;
        text-align: center;
    }

    /* Buttons */
    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-sm {
        padding: 6px 14px;
        font-size: 0.9rem;
    }

    .btn-lg {
        padding: 14px 32px;
        font-size: 1.1rem;
    }

    .btn-primary {
        background: #0f766e;
        color: white;
    }

        .btn-primary:hover:not(:disabled) {
            background: #0d6560;
        }

    .btn-secondary {
        background: #cbd5e0;
        color: #1e293b;
    }

        .btn-secondary:hover {
            background: #b0bec5;
        }

    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Empty States */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
    }

    .empty-icon {
        font-size: 3rem;
    }

    .empty-state p {
        color: #64748b;
        margin: 8px 0;
    }

    .empty-hint {
        font-size: 0.9rem !important;
        color: #94a3b8 !important;
    }

    .loading {
        text-align: center;
        padding: 40px;
        color: #64748b;
        font-style: italic;
    }

    /* Modal */
    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .modal-content {
        background: white;
        border-radius: 16px;
        max-width: 700px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 24px;
        border-bottom: 1px solid #e2e8f0;
    }

        .modal-header h2 {
            margin: 0;
            color: #0f766e;
        }

    .btn-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #64748b;
    }

    .modal-body {
        padding: 24px;
    }

    .detail-section {
        margin-bottom: 20px;
    }

        .detail-section label {
            display: block;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 6px;
        }

    .relation-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

        .relation-list li {
            padding: 6px 0;
            color: #64748b;
        }

    .pagination-info {
        text-align: center;
        padding: 16px;
        color: #64748b;
        font-size: 0.9rem;
    }

    .checkbox-label {
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        margin-bottom: 20px;
    }

    .extract-info {
        background: #f0fdfa;
        border: 1px solid #99f6e4;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
    }

        .extract-info h2 {
            margin: 0 0 8px;
            color: #0f766e;
        }

    .extraction-results {
        margin-top: 24px;
        padding: 20px;
        background: #f8fafc;
        border-radius: 10px;
    }

    .result-item {
        padding: 10px 0;
        border-bottom: 1px solid #e2e8f0;
    }
</style>

@code {
    // State
    private string activeTab = "entities";
    private List<BaseEntity> entities = new();
    private List<BaseEntity> filteredEntities = new();
    private List<Relation> relations = new();
    private List<Relation> filteredRelations = new();
    private BaseEntity? selectedEntity;

    private bool isLoadingEntities;
    private bool isLoadingRelations;
    private bool isExtracting;
    private bool useLLMExtraction;

    private string entitySearchQuery = "";
    private string entityTypeFilter = "";
    private string relationTypeFilter = "";

    private int totalEntities;
    private int totalRelations;

    private List<ExtractionResult> extractionResults = new();

    // Lifecycle
    protected override async Task OnInitializedAsync()
    {
        await LoadEntities();
        await LoadRelations();
    }

    // Entity Methods
    private async Task LoadEntities()
    {
        isLoadingEntities = true;
        StateHasChanged();

        try
        {
            entities = await DbContext.BaseEntities
                .Include(e => e.OutgoingRelations)
                .Include(e => e.IncomingRelations)
                .ToListAsync();

            totalEntities = entities.Count;
            FilterEntities();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Fehler beim Laden der Entities");
        }
        finally
        {
            isLoadingEntities = false;
            StateHasChanged();
        }
    }

    private void FilterEntities()
    {
        filteredEntities = entities
            .Where(e => string.IsNullOrEmpty(entitySearchQuery) ||
                       e.Name.Contains(entitySearchQuery, StringComparison.OrdinalIgnoreCase))
            .Where(e => string.IsNullOrEmpty(entityTypeFilter) ||
                       e.Discriminator == entityTypeFilter)
            .ToList();
    }

    private void OnEntityTypeFilterChanged(ChangeEventArgs e)
    {
        entityTypeFilter = e.Value?.ToString() ?? "";
        FilterEntities();
    }

    private void SelectEntity(BaseEntity entity)
    {
        selectedEntity = entity;
    }

    private void CloseEntityDetail()
    {
        selectedEntity = null;
    }

    // Relation Methods
    private async Task LoadRelations()
    {
        isLoadingRelations = true;
        StateHasChanged();

        try
        {
            relations = await DbContext.Relations
                .Include(r => r.SourceEntity)
                .Include(r => r.TargetEntity)
                .ToListAsync();

            totalRelations = relations.Count;
            FilterRelations();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Fehler beim Laden der Relationen");
        }
        finally
        {
            isLoadingRelations = false;
            StateHasChanged();
        }
    }

    private void FilterRelations()
    {
        filteredRelations = relations
            .Where(r => string.IsNullOrEmpty(relationTypeFilter) ||
                       r.RelationType == relationTypeFilter)
            .ToList();
    }

    private void OnRelationTypeFilterChanged(ChangeEventArgs e)
    {
        relationTypeFilter = e.Value?.ToString() ?? "";
        FilterRelations();
    }

    // Extraction Methods
    private async Task StartExtraction()
    {
        isExtracting = true;
        extractionResults.Clear();
        StateHasChanged();

        try
        {
            // TODO: Implementierung der Extraktion
            // Hier würde NerService + EntityPersistenceService aufgerufen
            await Task.Delay(2000); // Placeholder

            extractionResults.Add(new ExtractionResult
            {
                DocumentName = "Example.pdf",
                EntitiesCount = 15,
                RelationsCount = 8
            });

            await LoadEntities();
            await LoadRelations();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Fehler bei der Extraktion");
        }
        finally
        {
            isExtracting = false;
            StateHasChanged();
        }
    }

    // Helper Methods
    private string GetEntityIcon(string entityType) => entityType switch
    {
        "Person" => "👤",
        "Organization" => "🏢",
        "Organization:Company" => "🏭",
        "Organization:Bank" => "🏦",
        "Organization:NGO" => "🌍",
        "Organization:Agency" => "🛡️",
        "Organization:GovernmentAgency" => "🏛️",
        "Organization:SecretService" => "🕵️",
        "Organization:NewsMediaOrganization" => "📰",
        "Event" => "📅",
        _ => "📦"
    };

    private string GetShortType(string entityType) => entityType switch
    {
        "Organization:Company" => "Company",
        "Organization:Bank" => "Bank",
        "Organization:NGO" => "NGO",
        "Organization:Agency" => "Agency",
        "Organization:GovernmentAgency" => "Gov Agency",
        "Organization:SecretService" => "Secret Service",
        "Organization:NewsMediaOrganization" => "News Media",
        _ => entityType.Replace("Organization:", "")
    };

    private class ExtractionResult
    {
        public string DocumentName { get; set; } = "";
        public int EntitiesCount { get; set; }
        public int RelationsCount { get; set; }
    }
}
